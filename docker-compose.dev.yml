version: '2'
services:
  app:
    container_name: catbytes_webplatform
    build: .
    environment:
      NODE_ENV: development
    ports:
      - '8080:8080'
    command: npx nodemon --exec npm start
    volumes:
      - ~/.aws:/root/.aws:ro
  
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - ./loki-config.yml:/etc/loki/config.yml
    command: -config.file=/etc/loki/config.yml
  
  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    ports:
      - '12345:12345'
    volumes:
      - './config.alloy:/etc/alloy/config.alloy'
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    environment:
      GRAFANA_LOKI_URL: https://logs-prod-035.grafana.net/loki/api/v1/push
      GRAFANA_LOKI_USERNAME: 1191028
      GRAFANA_CLOUD_API_KEY: ${GRAFANA_CLOUD_API_KEY}
    command:
      - run
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
      - /etc/alloy/config.alloy
